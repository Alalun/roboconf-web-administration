
<!-- The Modal (Dialog) -->
<div class="modal fade" id="apps-modal" tabindex="-1" role="dialog" aria-labelledby="apps-modal-label" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
				<h4 class="modal-title" id="apps-modal-label">New Application</h4>
			</div>
			
			<div class="modal-body">
				<form name="new-app-form" id="new-app-form" action="{{ restUrl + '/applications' }}" method="POST" enctype="multipart/form-data">
							
					<div class="fileinput fileinput-new input-group" data-provides="fileinput" id="file-input-container">
						<div class="form-control" data-trigger="fileinput">
							<i class="glyphicon glyphicon-file fileinput-exists"></i> 
							<span class="fileinput-filename"></span>
						</div>
						
						<span class="input-group-addon btn btn-default btn-file">
							<span class="fileinput-new">Select file</span>
							<span class="fileinput-exists">Change</span>
							<input type="file" name="file" />
						</span>
						<a href="#" class="input-group-addon btn btn-default fileinput-exists" data-dismiss="fileinput">Remove</a>
						<span class="input-group-addon btn btn-default btn-default fileinput-exists" onClick="$( '#new-app-form' ).submit();">
							<i class="glyphicon glyphicon-upload"></i>
							Upload
						</span>
					</div>
					<p class="help-block">Select a ZIP file containing the application to deploy.</p>
				</form>
				
				<div class="progress">
  					<div class="progress-bar" id="app-upload-progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0;">
						0%
					</div>
				</div>
				
				<p id="upload-result"></p>
			</div>
			
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal" ng-click="closeUploadDialog()">Close</button>
			</div>
			
		</div> <!-- /.modal-content -->
	</div> <!-- /.modal-dialog -->
</div> <!-- /.modal -->


<!-- What happens when we click on 'Upload' -->
<script type="text/javascript">

	// Prepare the update of the progress bar
	var updateProgressBar = function( percentage ) {
		var progressBar = $( "#app-upload-progress-bar" );
		progressBar.css( "width", percentage + "%" );
		progressBar.text( percentage + "%" );
		progressBar.attr( "aria-valuenow", percentage )
	};
	
	// What happens when we click the "upload" button...
	$( "#new-app-form" ).submit( function( e ) {
		
		// Prevent the form from redirecting to the "action URL".
		e.stopPropagation();
		e.preventDefault();
		
		// Prepare the data to submit
		var formObj = $( this );
		var formData = new FormData( this );
			
		// Create an ajax request
		$.ajax({
			// This is to follow upload progression
			xhr: function() {
		        var xhr = new window.XMLHttpRequest();
		        xhr.upload.addEventListener("progress", function(evt) {
		            if( evt.lengthComputable ) {
		                var percentComplete = Math.round((evt.loaded * 100) / evt.total);
		                updateProgressBar( percentComplete );
		            }
		       }, false);

		       return xhr;
		    },
		    
		    // Other properties
			url : formObj.attr( "action" ),
			type : formObj.attr( "method" ),
			data : formData,
			mimeType : formObj.attr( "enctype" ),
			contentType : false,
			cache : false,
			processData : false,
			
			// Callbacks on success or failure
			success : function(data, textStatus, jqXHR) {
				$( "#upload-result" ).text( "The application was succesfully uploaded." );
			},
			error : function(jqXHR, textStatus, errorThrown) {
				$( "#upload-result" ).html( jqXHR.responseText );
			}
		});
			
		return false;
	});
	
</script>
